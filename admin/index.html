<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WalletWars Tournament Admin Tools</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Solana Web3.js - MUST LOAD FIRST -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- WalletWars Core Scripts - FIXED with ../ prefix -->
    <script src="../config.js"></script>
    <script src="../walletwars-api.js"></script>
    <script src="../wallet-service.js"></script>
    <script src="../global-wallet-manager.js"></script>
    <!-- SKIP: <script src="../walletwars-escrow-integration.js"></script> -->

    <!-- Tournament System Scripts from parent js folder -->
    <script src="../js/tournament-system/tournament-config.js"></script>
    <script src="../js/tournament-system/tournament-test-mode.js"></script>
    <script src="../js/tournament-system/tournament-deployment-manager.js"></script>
    <script src="../js/tournament-system/tournament-lifecycle-manager.js"></script>

    <!-- Admin specific script MUST BE LAST -->
    <script src="admin-auth.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            padding-top: 60px; /* Account for test mode banner */
        }

        .admin-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .admin-title {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .connection-status {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 0.5rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #10b981;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .admin-card {
            background: rgba(31, 41, 55, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 1rem;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #8b5cf6;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            color: #d1d5db;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.5rem;
            color: #ffffff;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.5rem;
            color: #ffffff;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #8b5cf6;
        }

        .btn-secondary:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-test {
            background: #f59e0b;
            color: white;
        }

        .btn-test:hover {
            background: #d97706;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: rgba(15, 23, 42, 0.5);
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #8b5cf6;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .output-console {
            background: #000;
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
        }

        .console-line {
            margin: 0.25rem 0;
            line-height: 1.4;
        }

        .console-success { color: #10b981; }
        .console-error { color: #ef4444; }
        .console-warning { color: #f59e0b; }
        .console-info { color: #06b6d4; }

        .info-box {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .test-mode-indicator {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #f59e0b;
            color: white;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 1rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(139, 92, 246, 0.3);
            border-radius: 50%;
            border-top-color: #8b5cf6;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <h1 class="admin-title">
                üõ°Ô∏è Tournament Admin Tools
                <span id="testModeIndicator" class="test-mode-indicator">TEST MODE</span>
            </h1>
            <p>Create and manage tournaments with on-chain escrow integration</p>
            
            <div class="connection-status">
                <div class="status-item">
                    <span class="status-dot" id="walletStatus"></span>
                    <span>Wallet: <span id="walletAddress">Not connected</span></span>
                </div>
                <div class="status-item">
                    <span class="status-dot" id="escrowStatus"></span>
                    <span>Escrow: <span id="escrowStatusText">Not initialized</span></span>
                </div>
                <div class="status-item">
                    <span class="status-dot" id="dbStatus"></span>
                    <span>Database: <span id="dbStatusText">Checking...</span></span>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value" id="totalTournaments">0</div>
                <div class="stat-label">Total Created</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="mockTournaments">0</div>
                <div class="stat-label">Mock (Test)</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="realTournaments">0</div>
                <div class="stat-label">Real (On-chain)</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="failedAttempts">0</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="admin-grid">
            <!-- Wallet Connection -->
            <div class="admin-card">
                <h3 class="card-title">
                    <span>üîó</span>
                    Wallet Connection
                </h3>
                
                <p style="margin-bottom: 1rem; color: #9ca3af;">
                    Connect the automation wallet to create tournaments
                </p>
                
                <div class="info-box">
                    <strong>Automation Wallet:</strong><br>
                    5D6ZYkQ5nAmZH1nm8u1rzbhVQ9vrQpXVe29qF9bcpEBJ
                </div>
                
                <button id="connectWalletBtn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    Connect Phantom Wallet
                </button>
                
                <div class="warning-box" style="margin-top: 1rem;">
                    <strong>‚ö†Ô∏è Important:</strong> Connect with Admin Wallet
                </div>
            </div>

            <!-- Quick Create Tournament -->
            <div class="admin-card">
                <h3 class="card-title">
                    <span>üéÆ</span>
                    Quick Create Tournament
                </h3>
                
                <form id="quickCreateForm">
                    <div class="form-group">
                        <label class="form-label">Tournament Name</label>
                        <input type="text" class="form-input" id="tournamentName" 
                               placeholder="Bronze Pure Wallet Championship" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tier</label>
                        <select class="form-select" id="tier" required>
                            <option value="0.01">Bronze (0.01 SOL)</option>
                            <option value="0.05">Silver (0.05 SOL)</option>
                            <option value="0.1">Gold (0.1 SOL)</option>
                            <option value="0.25">Diamond (0.25 SOL)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Trading Style</label>
                        <select class="form-select" id="tradingStyle" required>
                            <option value="pure_wallet">Pure Wallet</option>
                            <option value="open_trading">Open Trading</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Max Players</label>
                        <input type="number" class="form-input" id="maxPlayers" 
                               value="100" min="10" max="1000" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="datetime-local" class="form-input" id="startDate" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Create Tournament
                    </button>
                </form>
            </div>
        </div>

        <!-- Test Mode Controls -->
        <div class="admin-card" style="margin-bottom: 2rem;">
            <h3 class="card-title">
                <span>üß™</span>
                Test Mode Controls
            </h3>
            
            <div class="stats-grid">
                <button class="btn btn-test" onclick="createTestTournament()">
                    Create Test Tournament
                </button>
                <button class="btn btn-secondary" onclick="window.tournamentTestMode.showTestPanel()">
                    Open Test Panel
                </button>
                <button class="btn btn-secondary" onclick="showDeploymentStats()">
                    Show Stats
                </button>
                <button class="btn btn-danger" onclick="enableProductionMode()">
                    Enable Production Mode
                </button>
            </div>
            
            <div class="info-box" style="margin-top: 1rem;">
                <strong>Current Mode:</strong> <span id="currentMode">TEST MODE</span><br>
                <strong>One Real Test:</strong> <span id="oneRealTestStatus">Not used</span>
            </div>
        </div>

        <!-- Deployment Actions -->
        <div class="admin-card">
            <h3 class="card-title">
                <span>üöÄ</span>
                Deployment Actions
            </h3>
            
            <div style="display: grid; gap: 1rem;">
                <button class="btn btn-primary" onclick="deployUpcomingTournaments()">
                    Deploy Upcoming Tournaments
                </button>
                <button class="btn btn-secondary" onclick="checkExistingTournaments()">
                    Check Existing Tournaments
                </button>
                <button class="btn btn-secondary" onclick="clearConsole()">
                    Clear Console
                </button>
            </div>
        </div>

        <!-- Console Output -->
        <div class="admin-card" style="grid-column: 1 / -1;">
            <h3 class="card-title">
                <span>üíª</span>
                Console Output
            </h3>
            <div class="output-console" id="consoleOutput">
                <div class="console-line console-info">üöÄ Tournament Admin Tools initialized</div>
                <div class="console-line console-warning">üß™ Test mode is active - no real blockchain transactions</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let deploymentManager = null;
        let connectedWallet = null;
        
        // Console logging
        function log(message, type = 'info') {
            const console = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = `console-${type}`;
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            const line = document.createElement('div');
            line.className = `console-line ${typeClass}`;
            line.textContent = `[${timestamp}] ${icon} ${message}`;
            
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }
        
        // Clear console
        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = '<div class="console-line console-info">Console cleared</div>';
        }
        
        // Update UI elements
        function updateStatus(element, connected) {
            const dot = document.getElementById(element);
            if (connected) {
                dot.classList.add('connected');
            } else {
                dot.classList.remove('connected');
            }
        }
        
        // Update statistics
        function updateStats() {
            if (deploymentManager) {
                const stats = deploymentManager.getStats();
                document.getElementById('totalTournaments').textContent = stats.tournamentsCreated;
                document.getElementById('mockTournaments').textContent = stats.mockTournamentsCreated;
                document.getElementById('realTournaments').textContent = stats.realTournamentsCreated;
                document.getElementById('failedAttempts').textContent = stats.failedAttempts;
            }
        }
        
        // Connect wallet
        async function connectWallet() {
            log('Connecting to Phantom wallet...');
            
            try {
                const provider = window.phantom?.solana;
                
                if (!provider) {
                    throw new Error('Phantom wallet not found. Please install it.');
                }
                
                const response = await provider.connect();
                connectedWallet = provider;
                
                const address = response.publicKey.toString();
                document.getElementById('walletAddress').textContent = address.substring(0, 8) + '...';
                updateStatus('walletStatus', true);
                
                log(`Wallet connected: ${address}`, 'success');
                
                // Initialize deployment manager
                await initializeDeploymentManager();
                
            } catch (error) {
                log(`Failed to connect wallet: ${error.message}`, 'error');
                updateStatus('walletStatus', false);
            }
        }
        
        // Initialize deployment manager
        async function initializeDeploymentManager() {
            log('Initializing deployment manager...');
            
            try {
                deploymentManager = new window.EnhancedTournamentDeploymentManager();
                
                // Initialize escrow
                const escrowReady = await deploymentManager.initializeEscrow(connectedWallet);
                
                if (escrowReady) {
                    updateStatus('escrowStatus', true);
                    document.getElementById('escrowStatusText').textContent = 'Ready';
                    log('Escrow integration ready', 'success');
                } else {
                    updateStatus('escrowStatus', false);
                    document.getElementById('escrowStatusText').textContent = 'Failed';
                    log('Escrow integration failed', 'error');
                }
                
                updateStats();
                
            } catch (error) {
                log(`Failed to initialize deployment manager: ${error.message}`, 'error');
            }
        }
        
        // Create test tournament
        async function createTestTournament() {
            if (!deploymentManager) {
                log('Please connect wallet first', 'error');
                return;
            }
            
            log('Creating test tournament...');
            
            try {
                const result = await deploymentManager.createTestTournament();
                
                if (result) {
                    log(`Test tournament created: ${result.id}`, 'success');
                    updateStats();
                } else {
                    log('Failed to create test tournament', 'error');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }
        
        // Deploy upcoming tournaments
        async function deployUpcomingTournaments() {
            if (!deploymentManager) {
                log('Please connect wallet first', 'error');
                return;
            }
            
            const testMode = window.tournamentTestMode.isEnabled();
            if (testMode) {
                const confirm = window.confirm(
                    'Deploy tournaments in TEST MODE?\n\n' +
                    'This will create MOCK tournaments only.\n' +
                    'No real blockchain transactions will occur.'
                );
                
                if (!confirm) return;
            }
            
            log('Deploying upcoming tournaments...');
            
            try {
                await deploymentManager.deployUpcomingTournaments();
                updateStats();
            } catch (error) {
                log(`Deployment error: ${error.message}`, 'error');
            }
        }
        
        // Check existing tournaments
        async function checkExistingTournaments() {
            log('Checking existing tournaments...');
            
            try {
                const result = await window.walletWarsAPI.getUpcomingTournaments(10);
                
                if (result.success) {
                    log(`Found ${result.tournaments.length} upcoming tournaments:`, 'success');
                    
                    result.tournaments.forEach(t => {
                        const metadata = t.deployment_metadata || {};
                        const status = metadata.tournamentPDA ? '‚úÖ On-chain' : '‚ö†Ô∏è DB only';
                        log(`  ‚Ä¢ ${t.tournament_name} - ${t.status} ${status}`);
                    });
                } else {
                    log('Failed to load tournaments', 'error');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }
        
        // Show deployment stats
        function showDeploymentStats() {
            if (!deploymentManager) {
                log('Deployment manager not initialized', 'error');
                return;
            }
            
            const stats = deploymentManager.getStats();
            log('=== Deployment Statistics ===', 'info');
            log(`Total Created: ${stats.tournamentsCreated}`, 'info');
            log(`Mock Tournaments: ${stats.mockTournamentsCreated}`, 'info');
            log(`Real Tournaments: ${stats.realTournamentsCreated}`, 'info');
            log(`Failed Attempts: ${stats.failedAttempts}`, 'info');
            log(`Test Mode: ${stats.testModeActive ? 'ENABLED' : 'DISABLED'}`, stats.testModeActive ? 'warning' : 'success');
            log(`Escrow: ${stats.escrowInitialized ? 'Ready' : 'Not initialized'}`, stats.escrowInitialized ? 'success' : 'warning');
        }
        
        // Enable production mode
        function enableProductionMode() {
            window.tournamentTestMode.disable();
            document.getElementById('testModeIndicator').style.display = 'none';
            document.getElementById('currentMode').textContent = 'PRODUCTION MODE';
            updateTestModeStatus();
        }
        
        // Update test mode status
        function updateTestModeStatus() {
            const testMode = window.tournamentTestMode;
            const isEnabled = testMode.isEnabled();
            
            document.getElementById('testModeIndicator').style.display = isEnabled ? 'inline-block' : 'none';
            document.getElementById('currentMode').textContent = isEnabled ? 'TEST MODE' : 'PRODUCTION MODE';
            
            const config = testMode.config;
            if (config.realTestUsed) {
                document.getElementById('oneRealTestStatus').textContent = `Used (${config.realTestTournamentId})`;
            } else {
                document.getElementById('oneRealTestStatus').textContent = 'Available';
            }
        }
        
        // Handle quick create form
        document.getElementById('quickCreateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!deploymentManager) {
                log('Please connect wallet first', 'error');
                return;
            }
            
            const formData = {
                name: document.getElementById('tournamentName').value,
                entryFee: parseFloat(document.getElementById('tier').value),
                tradingStyle: document.getElementById('tradingStyle').value,
                maxParticipants: parseInt(document.getElementById('maxPlayers').value),
                startDate: new Date(document.getElementById('startDate').value)
            };
            
            log('Creating tournament: ' + formData.name);
            
            try {
                const result = await deploymentManager.createManualTournament(formData);
                
                if (result) {
                    log(`Tournament created successfully: ${result.id}`, 'success');
                    updateStats();
                    e.target.reset();
                } else {
                    log('Failed to create tournament', 'error');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        });
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            log('Tournament Admin Tools loaded');
            
            // Check database connection
            try {
                const dbConnected = await window.walletWarsAPI.testConnection();
                updateStatus('dbStatus', dbConnected);
                document.getElementById('dbStatusText').textContent = dbConnected ? 'Connected' : 'Failed';
                
                if (dbConnected) {
                    log('Database connection verified', 'success');
                } else {
                    log('Database connection failed', 'error');
                }
            } catch (error) {
                log('Database check failed: ' + error.message, 'error');
                updateStatus('dbStatus', false);
            }
            
            // Update test mode status
            updateTestModeStatus();
            
            // Connect wallet button
            document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
            
            // Set default start date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(14, 0, 0, 0); // 2 PM
            document.getElementById('startDate').value = tomorrow.toISOString().slice(0, 16);
        });
    </script>
</body>
</html>